--CREATE DATABASE chat_app

CREATE TABLE USER_METADATA (
    USERID SERIAL PRIMARY KEY,
    USERNAME VARCHAR UNIQUE,
    PASSWORD VARCHAR,
    NAME VARCHAR,
    EMAIL VARCHAR,
    SEX VARCHAR(3),
    ADDRESS VARCHAR,
    BIRTHDAY DATE,
    CREATEDTIME BIGINT DEFAULT EXTRACT(EPOCH FROM CURRENT_TIMESTAMP) * 1000,
    ISONLINE BOOLEAN DEFAULT FALSE,
    ISBLOCKED BOOLEAN DEFAULT FALSE
);

CREATE TABLE USER_FRIEND (
    USERID INTEGER REFERENCES USER_METADATA (USERID),
    FRIENDID INTEGER REFERENCES USER_METADATA (USERID),
    PRIMARY KEY (USERID, FRIENDID)
);

CREATE TABLE LOGIN_HISTORY (
    USERID INTEGER REFERENCES USER_METADATA (USERID),
    LOGINTIME BIGINT DEFAULT EXTRACT(EPOCH FROM CURRENT_TIMESTAMP) * 1000,
    PRIMARY KEY (USERID, LOGINTIME)
);

CREATE TABLE CHAT_METADATA (
    GROUPID SERIAL PRIMARY KEY,
    GROUPNAME VARCHAR,
    CREATEDTIME BIGINT DEFAULT EXTRACT(EPOCH FROM CURRENT_TIMESTAMP) * 1000,
    ISGROUP BOOLEAN
);

CREATE TABLE USER_GROUPCHAT_LIST (
    USERID INTEGER REFERENCES USER_METADATA (USERID),
    GROUPID INTEGER REFERENCES CHAT_METADATA (GROUPID),
    PRIMARY KEY (USERID, GROUPID)
);

CREATE TABLE USER_BLOCK_LIST (
    USERID INTEGER REFERENCES USER_METADATA (USERID),
    USERISBLOCKED INTEGER REFERENCES USER_METADATA (USERID),
    PRIMARY KEY (USERID, USERISBLOCKED)
);

CREATE TABLE SPAM_REPORT (
    REPORTID SERIAL PRIMARY KEY,
    USERSENT INTEGER REFERENCES USER_METADATA (USERID),
    USERISREPORTED INTEGER REFERENCES USER_METADATA (USERID),
    CREATEDTIME BIGINT DEFAULT EXTRACT(EPOCH FROM CURRENT_TIMESTAMP) * 1000,
    STATUS VARCHAR(10),
    CONTENT VARCHAR,
    CONSTRAINT USER_CHECK CHECK (USERSENT <> USERISREPORTED)
);

CREATE TABLE CHAT_MEMBER (
    GROUPCHATID INTEGER REFERENCES CHAT_METADATA (GROUPID),
    MEMBERID INTEGER REFERENCES USER_METADATA (USERID),
    PRIMARY KEY (GROUPCHATID, MEMBERID)
);

CREATE TABLE CHAT_CONTENT (
    GROUPID INTEGER REFERENCES CHAT_METADATA (GROUPID),
    USERSENT INTEGER REFERENCES USER_METADATA (USERID),
    MSG VARCHAR,
    MSG_OFFSET INTEGER,
    SENTTIME BIGINT DEFAULT EXTRACT(EPOCH FROM CURRENT_TIMESTAMP) * 1000,
    PRIMARY KEY (GROUPID, SENTTIME)
);

CREATE TABLE GROUP_ADMINS (
    GROUPID INTEGER REFERENCES CHAT_METADATA (GROUPID),
    ADMINID INTEGER REFERENCES USER_METADATA (USERID),
    PRIMARY KEY (GROUPID, ADMINID)
);

CREATE TABLE CHAT_OFFSET (
    GROUPID INTEGER REFERENCES CHAT_METADATA (GROUPID),
    USERID INTEGER REFERENCES USER_METADATA (USERID),
    LASTSEENOFFSET INTEGER,
    LASTRECEIVEDOFFSET INTEGER,
    PRIMARY KEY (GROUPID, USERID)
);

INSERT INTO USER_METADATA (USERNAME, PASSWORD, NAME, ADDRESS, BIRTHDAY, SEX, EMAIL, CREATEDTIME) VALUES
('usn1', '1234', N'Nguyễn Xuân Huy', N'Đà Nẵng', '1999-01-01', N'Nam', 'usn1@gmail.com', EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-12-25 20:30:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
('usn2', '1234', N'Lê Ngọc Nhi', N'An Giang', '1998-09-06', N'Nữ', 'usn2@gmail.com', EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-07-09 09:45:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
('usn3', '1234', N'Nguyễn Thị Thanh Thảo', N'Sóc Trăng', '2000-11-21', N'Nữ', 'usn3@gmail.com', EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-01-24 12:36:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
('usn4', '1234', N'Nghiêm Xuân Huy', N'Cần Thơ', '1997-08-15', N'Nam', 'usn4@gmail.com', EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-12-05 22:20:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
('usn5', '1234', N'Lương Xuân Trường', N'Tuyên Quang', '1995-04-28', N'Nam', 'usn5@gmail.com', EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-01-22 08:27:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
('usn6', '1234', N'Nguyễn Văn Bình', N'Quảng Nam', '1992-10-30', N'Nam', 'usn6@gmail.com', EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-04-28 15:30:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
('usn7', '1234', N'Phạm Băng Băng', N'Bến Tre', '1981-09-16', N'Nữ', 'usn7@gmail.com', EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-12-05 20:30:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
('usn8', '1234', N'Chu Thị Trà', N'Hải Phòng', '2001-12-01', N'Nữ', 'usn8@gmail.com', EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-03-15 06:10:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
('usn9', '1234', N'Đinh Bá Tiến', N'Nasa', '1999-11-21', N'Nam', 'usn9@gmail.com', EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-04-29 12:35:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000);

INSERT INTO USER_METADATA (USERID,USERNAME, PASSWORD) VALUES (0,'admin','admin');

INSERT INTO USER_FRIEND (USERID, FRIENDID) VALUES
(1, 3), (3, 1),
(1, 5), (5, 1),
(1, 7), (7, 1),
(2, 3), (3, 2),
(2, 4), (4, 2),
(3, 7), (7, 3),
(3, 9), (9, 3),
(4, 6), (6, 4),
(5, 6), (6, 5),
(5, 7), (7, 5),
(6, 9), (9, 6),
(7, 8), (8, 7);

INSERT INTO LOGIN_HISTORY (USERID, LOGINTIME) VALUES
(1, EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-12-25 20:30:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(2, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-07-09 09:45:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(1, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-01-24 12:36:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(1, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-11-05 22:20:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(5, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-02-22 08:27:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(8, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-05-28 15:30:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(7, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-12-05 20:30:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(8, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-10-15 06:10:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(2, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-09-29 12:35:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000);

INSERT INTO CHAT_METADATA (GROUPNAME, CREATEDTIME, ISGROUP) VALUES
('Group 1', EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-02-25 20:30:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000, TRUE),
('Group 2', EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-07-19 09:45:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000, FALSE),
('Group 3', EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-11-14 12:36:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000, TRUE),
('Group 4', EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-12-05 22:20:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000, FALSE);

INSERT INTO USER_GROUPCHAT_LIST (USERID, GROUPID) VALUES
(1, 1), (2, 1), (3, 1), (4, 1),
(2, 2), (3, 2),
(2, 3), (3, 3), (4, 3),
(1, 4), (4, 4);

INSERT INTO USER_BLOCK_LIST (USERID, USERISBLOCKED) VALUES
(1, 2), (2, 4), (3, 4);

INSERT INTO SPAM_REPORT (USERSENT, USERISREPORTED, STATUS, CONTENT, CREATEDTIME) VALUES
(1, 2, 'PENDING', 'Spam', EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-11-01 20:30:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(1, 4, 'PENDING', 'Spam', EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-11-06 12:30:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(2, 4, 'PROCESSED', 'Spam', EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-10-30 19:31:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(3, 4, 'REJECTED', 'Spam', EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-10-31 15:28:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000);

INSERT INTO CHAT_MEMBER (GROUPCHATID, MEMBERID) VALUES
(1, 1), (1, 2), (1, 3), (1, 4),
(2, 2), (2, 3),
(3, 2), (3, 3), (3, 4),
(4, 1), (4, 4);

INSERT INTO CHAT_CONTENT (GROUPID, USERSENT, MSG, MSG_OFFSET, SENTTIME) VALUES
(1, 1, 'Hello', 1, EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-02-25 20:30:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(1, 2, 'Hi', 2,EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-02-25 20:31:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(1, 3, 'How are you?', 3, EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-02-25 20:32:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(1, 4, 'I am fine', 4, EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-02-25 20:33:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(1, 1, 'What are you doing?', 5, EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-02-25 20:34:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(1, 2, 'I am doing homework', 6, EXTRACT(EPOCH FROM TO_TIMESTAMP('2022-02-25 20:35:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(2, 2, 'Hello', 1, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-07-19 09:45:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(2, 3, 'Hi', 2, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-07-19 09:46:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(2, 2, 'How are you?', 3, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-07-19 09:47:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(2, 3, 'I am fine', 4, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-07-19 09:48:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(2, 2, 'What are you doing?', 5, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-07-19 09:49:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(2, 3, 'I am doing homework', 6, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-07-19 09:50:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(3, 2, 'Hello', 1, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-11-14 12:36:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(3, 3, 'Hi', 2, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-11-14 12:37:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(3, 2, 'How are you?', 3, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-11-14 12:38:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(3, 3, 'I am fine', 4, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-11-14 12:39:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(3, 2, 'What are you doing?', 5, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-11-14 12:40:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(3, 3, 'I am doing homework', 6, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-11-14 12:41:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(4, 1, 'Hello', 1, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-12-05 22:20:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(4, 4, 'Hi', 2, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-12-05 22:21:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(4, 1, 'How are you?', 3, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-12-05 22:22:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(4, 4, 'I am fine', 4, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-12-05 22:23:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(4, 1, 'What are you doing?', 5, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-12-05 22:24:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000),
(4, 4, 'I am doing homework', 6, EXTRACT(EPOCH FROM TO_TIMESTAMP('2023-12-05 22:25:00', 'YYYY-MM-DD HH24:MI:SS')) * 1000);

INSERT INTO GROUP_ADMINS (GROUPID, ADMINID) VALUES
(1, 1), (1, 2), (3, 2), (3, 4);

INSERT INTO CHAT_OFFSET (GROUPID, USERID, LASTSEENOFFSET, LASTRECEIVEDOFFSET) VALUES
(1, 1, 5, 6), (1, 2, 6, 6), (1, 3, 4, 6), (1, 4, 5, 6),
(2, 2, 5, 6), (2, 3, 6, 6),
(3, 2, 6, 6), (3, 3, 6, 6), (3, 4, 0, 6),
(4, 1, 6, 6), (4, 4, 6, 6);
